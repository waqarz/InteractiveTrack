<!DOCTYPE html> 
  
<html lang="en"> 

<head> 
   <meta charset="utf-8"> 
   <title>Custom HTML5 Video Player</title> 
   <link rel="stylesheet" type="text/css" href="style.css">
   <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
   <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>    
   <script src="http://code.jquery.com/jquery-latest.js"></script>
</head> 

<body>

<p>Start playback.</p>

<button onclick="myFunction()">Click to play</button>

<p id="demo"></p>


<div>
    <input type="checkbox" id="interactivity" value="yes"> Enable interactivity<br>
</div>



</body>

<script>

var mainTimerHandle = "";
var ticksPerSecond = 10;    //Define timer resolution
var vid;
var interactivityEnabled = 0;

window.onload = function()
    {	
        initializeSamples();
    }
    
function myFunction() {
    document.getElementById("demo").innerHTML = "Started";
    var startTime = new Date().getTime() / 1000; // The time in sec since 1 Jan 1970.
    $.post(
            "writeStartTime.php",
            {startTime: startTime }
            ).done(function(response){
            console.log(response);
        });
                 


    if(document.getElementById("interactivity").checked)
        interactivityEnabled = 1;
    
    setTimeout(loadMainBody, 0); // Lo
    setTimeout(initializeVideo, 10);
    //mainTimerHandle = setInterval(mainTimer, 1000/ticksPerSecond);    
}

var mainIterationCount = 0;
var scriptAdded = new Boolean(false);

var sampleDecodeTimes  = [0, 0.5, 1];    //Decode times, less than the expected presentation times: check how loading the movie from remote server/buffering may impact this. The other decode times are read during the run-time.
var currentSample = 0;
var accumulatedTime = 1;
var video_previous_playback_time = -1;
var rightImageIncoming=0;

function initializeVideo() {
  vid = document.getElementById("video");
  console.log(vid);
  vid.ontimeupdate = function () { 
	  mainTimer(((vid.currentTime)));
	  emulateReceiveAndStoreFunction(); 
	  emulateReceiveAndStoreLeftThumbnail(); 
	  addRemoveRightThumbnail();
	  removeRightImage();//To remove right side image by broadcaster after a certain time of display.
    };
  
  vid.onended=function(){
          initializeSamples();
  }
}

function mainTimer(currentPlaybackTime) {
  console.log(currentPlaybackTime)
  currentPlaybackTime = Math.round(currentPlaybackTime);
  //console.log("Current playback time =" + currentPlaybackTime);
  //console.log("Video previous playback time =" + video_previous_playback_time);
  //console.log("Sample decode time =" + sampleDecodeTimes[currentSample]);
  if ((video_previous_playback_time != currentPlaybackTime) && (currentSample < 65)){
    //console.log("** Current sample is " + currentSample);
    if ( (currentPlaybackTime == sampleDecodeTimes[currentSample]) || ((currentPlaybackTime - 0.5) == sampleDecodeTimes[currentSample]) || ((currentPlaybackTime + 0.5) == sampleDecodeTimes[currentSample]) )  //Assuming timer is accurate (defined by ticksPerSecond)
      {
	  console.log("*********Playbacktime: " + currentPlaybackTime + ", loading: " + "InteractiveTrack/sample" + (currentSample) + ".tr");
	  setTimeout(function(){loadScript("InteractiveTrack/sample" + (currentSample) + ".tr", 0);}, 0);
	  currentPlaybackTime = sampleDecodeTimes[currentSample];
	  //Load a sample	  
	  currentSample = currentSample + 1;  //Iterate over samples
      }
    video_previous_playback_time = currentPlaybackTime;
  }    
}

function loadMainBody()
{
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {      
        var nodeContents = this.responseText;
        document.getElementsByTagName('body')[0].innerHTML = nodeContents;
        loadScript("InteractiveTrack/main.tr", 1);
    }
  };
  xhttp.open("GET", "InteractiveTrack/body.xml", true);
  xhttp.send();
}

function loadScript(scriptName, isSampleZero)
{
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        //console.log("** Script name is " + scriptName);
      
	if(isSampleZero){
	  var scriptContents = this.responseText;
	  var theScript = document.createElement('script');
	  theScript.appendChild(document.createTextNode(scriptContents));
	  document.getElementsByTagName('head')[0].appendChild(theScript);
	  scriptAdded = true;
	}
	else{
	  var scriptContentsWithTime = this.responseText;
	  var scriptContents;
	  var components = scriptContentsWithTime.split('\n');
	  time = components.shift();
	  accumulatedTime = Math.round((accumulatedTime + Number(time))*10)/10;
	  sampleDecodeTimes.push(accumulatedTime);
	  console.log(sampleDecodeTimes);
	  
	  scriptContents = components.join('\n');    
	  var theScript = document.createElement('script');	  
	  theScript.appendChild(document.createTextNode(scriptContents));
	  document.getElementsByTagName('head')[0].appendChild(theScript);
	  scriptAdded = true;
	}        
    }
  };
  xhttp.open("GET", scriptName, true);
  xhttp.send();
}

function loadXMLDoc() {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("demo").innerHTML =
      this.responseText;
    }
  };
  xhttp.open("GET", "xmlhttp_info.txt", true);
  xhttp.send();
}

function removeRightImage(){
    if(rightImageIncoming)
    {
        
        setTimeout(function(){
            document.getElementById("img_4").src = "" ;
            document.getElementById("links_4").href = "";
            document.getElementById("links_text_4").innerHTML = "";
        },3000) // Time out for 4s.
        
        rightImageIncoming=0;
    }
    
}
function initializeSamples(){
    $.post(
            "ReinitializeSamples.php",
            ).done(function(response){
            console.log(response);
        });
}
</script>


</html>
